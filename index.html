<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pronunciation Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f8fb;
      margin: 0;
      padding: 16px;
    }

    .card {
      max-width: 420px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }

    #word {
      font-size: 28px;
      text-align: center;
      margin-bottom: 16px;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background: #1976ff;
      color: #fff;
    }

    button:active {
      background: #1258c7;
    }

    #status {
      text-align: center;
      margin: 12px 0;
      color: #555;
    }

    audio {
      width: 100%;
      margin-top: 10px;
      accent-color: #1976ff;
    }

    #scores {
      margin-top: 14px;
      font-size: 15px;
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <div class="card">
    <div id="word">example</div>

    <button id="recordBtn">按住录音，松开测评</button>

    <div id="status">准备就绪</div>

    <audio id="player" controls></audio>

    <div id="scores"></div>
  </div>

<script>
let mediaRecorder;
let chunks = [];
let stream;

const recordBtn = document.getElementById("recordBtn");
const status = document.getElementById("status");
const player = document.getElementById("player");

async function initMic() {
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
}

recordBtn.addEventListener("touchstart", startRecord);
recordBtn.addEventListener("mousedown", startRecord);

recordBtn.addEventListener("touchend", stopRecord);
recordBtn.addEventListener("mouseup", stopRecord);

async function startRecord(e) {
  e.preventDefault();
  if (!stream) await initMic();

  chunks = [];
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.start();

  mediaRecorder.ondataavailable = e => chunks.push(e.data);

  status.innerText = "录音中…";
}

async function stopRecord(e) {
  e.preventDefault();
  if (!mediaRecorder || mediaRecorder.state !== "recording") return;

  mediaRecorder.stop();

  mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(chunks, { type: "audio/webm" });
    player.src = URL.createObjectURL(audioBlob);

    await sendToAzure(audioBlob);
  };
}

async function sendToAzure(audioBlob) {
  const word = document.getElementById("word").innerText;
  const scoresDiv = document.getElementById("scores");

  status.innerText = "测评中…";
  scoresDiv.innerHTML = "";

  try {
    const res = await fetch(
      "https://anki-pronunciation.onrender.com/assess?text=" +
        encodeURIComponent(word),
      {
        method: "POST",
        body: audioBlob
      }
    );

    const data = await res.json();
    const pa = data.NBest[0].PronunciationAssessment;

    status.innerText = "测评完成";
    scoresDiv.innerHTML = `
      <strong>总分：</strong>${Math.round(pa.PronunciationScore)}<br>
      Accuracy：${Math.round(pa.AccuracyScore)}<br>
      Fluency：${Math.round(pa.FluencyScore)}<br>
      Completeness：${Math.round(pa.CompletenessScore)}
    `;
  } catch (err) {
    console.error(err);
    status.innerText = "测评失败，请重试";
  }
}
</script>
</body>
</html>
