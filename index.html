<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anki Pronunciation Assessment</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Azure Speech SDK -->
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        /* 隐藏滚动条但允许滚动 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .mic-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .mic-btn:active { transform: scale(0.95); }
        .wave-anim { animation: wave 1.5s infinite linear; }
        @keyframes wave {
            0% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 0.3; }
            100% { transform: scale(1); opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. 内联图标组件 (修复 React.createElement 错误) ---
        const Icon = ({ children, size = 24, className = "", ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                {...props}
            >
                {children}
            </svg>
        );

        const Mic = (props) => (
            <Icon {...props}>
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" x2="12" y1="19" y2="23"/>
                <line x1="8" x2="16" y1="23" y2="23"/>
            </Icon>
        );

        const Square = (props) => (
            <Icon {...props}>
                <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
            </Icon>
        );

        const AlertCircle = (props) => (
            <Icon {...props}>
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" x2="12" y1="8" y2="12"/>
                <line x1="12" x2="12.01" y1="16" y2="16"/>
            </Icon>
        );

        const Loader2 = (props) => (
            <Icon {...props}>
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </Icon>
        );

        // --- 2. 主应用组件 ---
        const App = () => {
            // 状态管理
            const [params, setParams] = useState({ word: 'Example', phonetic: '', key: '', region: '' });
            const [status, setStatus] = useState('idle'); // idle, recording, analyzing, success, error
            const [score, setScore] = useState(null);
            const [audioUrl, setAudioUrl] = useState(null);
            const [errorMsg, setErrorMsg] = useState('');
            
            const recognizerRef = useRef(null);
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);

            // 初始化：从 URL 获取参数
            useEffect(() => {
                const searchParams = new URLSearchParams(window.location.search);
                const newParams = {
                    word: searchParams.get('word') || 'Hello',
                    phonetic: searchParams.get('phonetic') || '',
                    key: searchParams.get('key') || '',
                    region: searchParams.get('region') || ''
                };
                setParams(newParams);
                
                // 唤醒 iOS AudioContext
                const unlockAudio = () => {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        const ctx = new AudioContext();
                        if (ctx.state === 'suspended') {
                            ctx.resume();
                        }
                    }
                    document.removeEventListener('touchstart', unlockAudio);
                    document.removeEventListener('click', unlockAudio);
                };
                document.addEventListener('touchstart', unlockAudio);
                document.addEventListener('click', unlockAudio);

                return () => stopEverything();
            }, []);

            const stopEverything = () => {
                if (recognizerRef.current) {
                    try { recognizerRef.current.close(); } catch(e){}
                    recognizerRef.current = null;
                }
                if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                    mediaRecorderRef.current.stop();
                }
            };

            // 开始录音与评测
            const startRecording = async () => {
                setErrorMsg('');
                setScore(null);
                setAudioUrl(null);
                
                if (!params.key || !params.region) {
                    setErrorMsg("缺少 Azure API Key 或 Region，请检查 Anki 卡片配置。");
                    return;
                }

                try {
                    // A. 获取麦克风流 (用于本地回放)
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    audioChunksRef.current = [];
                    
                    mediaRecorderRef.current.ondataavailable = (event) => {
                        audioChunksRef.current.push(event.data);
                    };
                    
                    mediaRecorderRef.current.onstop = () => {
                        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/wav' });
                        const url = URL.createObjectURL(audioBlob);
                        setAudioUrl(url); // 生成可播放的链接
                    };
                    
                    mediaRecorderRef.current.start();

                    // B. 配置 Azure Speech SDK (用于评测)
                    const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(params.key, params.region);
                    speechConfig.speechRecognitionLanguage = "en-US";
                    
                    const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                    
                    // 核心：创建评测配置
                    const pronunciationAssessmentConfig = new SpeechSDK.PronunciationAssessmentConfig(
                        params.word,
                        SpeechSDK.PronunciationAssessmentGradingSystem.HundredMark,
                        SpeechSDK.PronunciationAssessmentGranularity.Phoneme,
                        true
                    );

                    const recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                    pronunciationAssessmentConfig.applyTo(recognizer);

                    recognizerRef.current = recognizer;
                    
                    setStatus('recording');

                    // 开始识别
                    recognizer.recognizeOnceAsync(
                        (result) => {
                            setStatus('analyzing');
                            if (result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                                const pronunciationResult = SpeechSDK.PronunciationAssessmentResult.fromResult(result);
                                setScore(Math.round(pronunciationResult.accuracyScore));
                                setStatus('success');
                            } else {
                                setErrorMsg('无法识别，请再试一次');
                                setStatus('error');
                            }
                            // 停止录音机
                            if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                                mediaRecorderRef.current.stop();
                            }
                            recognizer.close();
                            recognizerRef.current = null;
                        },
                        (err) => {
                            setErrorMsg('评测出错: ' + err);
                            setStatus('error');
                            if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                                mediaRecorderRef.current.stop();
                            }
                            recognizer.close();
                            recognizerRef.current = null;
                        }
                    );

                } catch (err) {
                    console.error(err);
                    setErrorMsg("无法访问麦克风，请确保允许权限 (Permission Denied)");
                    setStatus('error');
                }
            };

            const stopRecording = () => {
                // Azure SDK 的 recognizeOnceAsync 会自动停止，但用户手动点击停止时触发
                if (recognizerRef.current) {
                    // 这里我们不直接 close，而是让它完成当前的识别
                }
            };

            // 界面渲染
            return (
                <div className="flex flex-col items-center justify-start min-h-screen p-4 pt-8 bg-white">
                    {/* 单词显示区 */}
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-slate-800 mb-2">{params.word}</h1>
                        <p className="text-xl text-slate-500 font-mono">{params.phonetic}</p>
                    </div>

                    {/* 评分圆环 */}
                    <div className="relative w-32 h-32 flex items-center justify-center mb-8">
                         {status === 'analyzing' ? (
                             <div className="absolute inset-0 flex items-center justify-center text-blue-500">
                                <Loader2 size={48} className="animate-spin" />
                             </div>
                         ) : score !== null ? (
                             <div className={`text-5xl font-bold ${score >= 80 ? 'text-green-500' : score >= 60 ? 'text-yellow-500' : 'text-red-500'}`}>
                                 {score}
                             </div>
                         ) : (
                             <div className="text-gray-300">
                                <Mic size={48} />
                             </div>
                         )}
                         
                         {/* 状态文字 */}
                         <div className="absolute -bottom-8 w-full text-center text-sm font-medium text-gray-500">
                             {status === 'idle' && '点击录音'}
                             {status === 'recording' && '正在聆听...'}
                             {status === 'analyzing' && '正在评分...'}
                             {status === 'success' && '评测完成'}
                             {status === 'error' && '出错'}
                         </div>
                    </div>

                    {/* 错误提示 */}
                    {errorMsg && (
                        <div className="mb-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm flex items-center gap-2">
                            <AlertCircle size={16} /> {errorMsg}
                        </div>
                    )}

                    {/* 录音控制按钮 - 尺寸调小 20% (w-16 -> w-14) */}
                    <div className="mb-6 z-10">
                        {status === 'recording' ? (
                            <button 
                                onClick={stopRecording} 
                                className="w-14 h-14 rounded-full bg-red-500 flex items-center justify-center shadow-lg shadow-red-200 wave-anim"
                            >
                                <Square size={20} fill="white" className="text-white" />
                            </button>
                        ) : (
                            <button 
                                onClick={startRecording}
                                disabled={status === 'analyzing'}
                                className={`w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-all ${
                                    status === 'analyzing' ? 'bg-gray-200 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200 active:scale-95'
                                }`}
                            >
                                <Mic size={24} className="text-white" />
                            </button>
                        )}
                    </div>

                    {/* 系统播放器 - 解决无法点击问题 */}
                    {audioUrl && (
                        <div className="w-full max-w-xs bg-slate-50 p-3 rounded-xl border border-slate-200 animate-in fade-in slide-in-from-bottom-4">
                            <p className="text-xs text-slate-400 mb-2 font-medium uppercase tracking-wider">我的录音回放</p>
                            <audio 
                                controls 
                                src={audioUrl} 
                                className="w-full h-8" 
                                style={{ borderRadius: '4px' }}
                            ></audio>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>